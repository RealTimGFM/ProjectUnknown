name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies (CI)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-ci.txt

      - name: Verify compiled allowlists exist
        shell: bash
        run: |
          python - <<'PY'
          from pathlib import Path

          candidates = [
              Path("compiled"),
              Path("data/allowlists/compiled"),
          ]

          required = [
              "tech_allowlist.txt",
              "tech_aliases.json",
              "skills_allowlist.txt",
              "skills_aliases.json",
          ]

          found_base = None
          for base in candidates:
              if all((base / f).exists() for f in required):
                  found_base = base
                  break

          if not found_base:
              missing = []
              for base in candidates:
                  for f in required:
                      if not (base / f).exists():
                          missing.append(str(base / f))
              raise SystemExit(
                  "Missing compiled allowlists. Expected these files in either "
                  "'compiled/' or 'data/allowlists/compiled/'. Missing:\n- "
                  + "\n- ".join(sorted(set(missing)))
                  + "\n\nFix: run locally then commit outputs:\n"
                  "  python -m tools.build_allowlists\n"
                  "(raw datasets must exist locally under data/allowlists/raw/.)"
              )

          print(f"OK: compiled allowlists present in: {found_base}")
          PY

      - name: Run tests
        run: |
          pytest -q
